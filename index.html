<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Level Englisch Vokabel-Spiel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .level-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
        }

        .level-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .level-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .level-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .level-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .highscore {
            background: #e7f3ff;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            color: #0066cc;
        }

        .game-area {
            padding: 30px;
            display: none;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #dc3545;
        }

        .progress {
            font-size: 18px;
            color: #667eea;
        }

        /* Level 1: Drag & Drop */
        .drag-drop-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .word-list {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            min-height: 400px;
        }

        .word-item {
            background: #667eea;
            color: white;
            padding: 12px 20px;
            margin: 10px 0;
            border-radius: 25px;
            cursor: grab;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s;
        }

        .word-item:hover {
            background: #5a67d8;
            transform: scale(1.05);
        }

        .word-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .drop-zone {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: #e7f3ff;
        }

        .drop-zone.filled {
            border-color: #28a745;
            background: #d4edda;
        }

        /* Level 2: Translation */
        .translation-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .translation-input {
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            width: 200px;
        }

        .translation-input.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .translation-input.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        /* Level 3: Crossword */
        .crossword-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .crossword-grid {
            display: grid;
            grid-template-columns: repeat(15, 32px);
            grid-template-rows: repeat(15, 32px);
            gap: 1px;
            background: #333;
            padding: 15px;
            border-radius: 10px;
            position: relative;
        }

        .crossword-cell {
            background: white;
            border: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            position: relative;
            cursor: pointer;
        }

        .crossword-cell.blocked {
            background: #333;
            border: none;
        }

        .crossword-cell.active {
            background: #fff3cd !important;
        }

        .crossword-cell.current-word {
            background: #e7f3ff;
        }

        .crossword-cell.filled {
            background: #d4edda;
        }

        .crossword-cell input {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .crossword-cell input:focus {
            outline: 2px solid #667eea;
        }

        .crossword-number {
            position: absolute;
            top: 1px;
            left: 2px;
            font-size: 8px;
            color: #333;
            font-weight: bold;
        }

        .crossword-clues {
            min-width: 300px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .clues-section {
            margin-bottom: 25px;
        }

        .clues-title {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .clue-item {
            padding: 8px 12px;
            margin: 3px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .clue-item:hover {
            background: #e9ecef;
            border-left-color: #667eea;
        }

        .clue-item.active {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .clue-item.completed {
            background: #d4edda;
            border-left-color: #28a745;
            opacity: 0.7;
        }

        .clue-number {
            font-weight: bold;
            color: #667eea;
        }

        /* Level 4: AI Description */
        .description-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
        }

        .word-to-describe {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }

        .description-input {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            resize: vertical;
        }

        .ai-feedback {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            color: #004085;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: left;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .final-score {
            text-align: center;
            padding: 40px;
        }

        .score-display {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Multi-Level Englisch Vokabel-Spiel</h1>
            <p>W√§hle dein Level und stelle dich der Herausforderung!</p>
        </div>

        <!-- Level Selector -->
        <div class="level-selector" id="levelSelector">
            <div class="level-card" onclick="startLevel(1)">
                <div class="level-icon">üîó</div>
                <div class="level-title">Level 1: Zuordnung</div>
                <div class="level-description">20 W√∂rter per Drag & Drop zuordnen</div>
                <div class="highscore" id="highscore1">Bester: --</div>
            </div>
            
            <div class="level-card" onclick="startLevel(2)">
                <div class="level-icon">‚úçÔ∏è</div>
                <div class="level-title">Level 2: √úbersetzung</div>
                <div class="level-description">15 deutsche W√∂rter ins Englische √ºbersetzen</div>
                <div class="highscore" id="highscore2">Bester: --</div>
            </div>
            
            <div class="level-card" onclick="startLevel(3)">
                <div class="level-icon">üß©</div>
                <div class="level-title">Level 3: Kreuzwortr√§tsel</div>
                <div class="level-description">10 W√∂rter im Kreuzwortr√§tsel finden</div>
                <div class="highscore" id="highscore3">Bester: --</div>
            </div>
            
            <div class="level-card" onclick="startLevel(4)">
                <div class="level-icon">ü§ñ</div>
                <div class="level-title">Level 4: KI-Bewertung</div>
                <div class="level-description">5 W√∂rter auf Englisch beschreiben</div>
                <div class="highscore" id="highscore4">Bester: --</div>
            </div>
        </div>

        <!-- Game Area -->
        <div class="game-area" id="gameArea">
            <div class="game-header">
                <button class="btn btn-secondary" onclick="backToMenu()">‚Üê Zur√ºck zum Men√º</button>
                <div class="progress" id="progress">Frage 1 von 20</div>
                <div class="timer" id="timer">00:00</div>
            </div>
            
            <div id="gameContent"></div>
            
            <div class="final-score hidden" id="finalScore">
                <h2 id="finalTitle">Level abgeschlossen!</h2>
                <div class="score-display" id="finalTime">02:34</div>
                <p id="finalMessage">Gratulation! Du hast einen neuen Rekord aufgestellt!</p>
                <button class="btn btn-primary" onclick="backToMenu()">Zur√ºck zum Men√º</button>
                <button class="btn btn-success" onclick="restartLevel()">Level wiederholen</button>
            </div>
        </div>
    </div>

    <script>
        // Vokabeln mit deutschen √úbersetzungen
        const vocabulary = [
            {english: "clothing", german: "kleidung"},
            {english: "jumper", german: "pullover"},
            {english: "shoes", german: "schuhe"},
            {english: "trousers", german: "hose"},
            {english: "pants", german: "hose"},
            {english: "blouse", german: "bluse"},
            {english: "cap", german: "m√ºtze"},
            {english: "belt", german: "g√ºrtel"},
            {english: "watch", german: "uhr"},
            {english: "student", german: "sch√ºler"},
            {english: "sunglasses", german: "sonnenbrille"},
            {english: "backpack", german: "rucksack"},
            {english: "school playground", german: "schulhof"},
            {english: "at school", german: "in der schule"},
            {english: "interested", german: "interessiert"},
            {english: "good", german: "gut"},
            {english: "favourite", german: "lieblings"},
            {english: "favorite", german: "lieblings"},
            {english: "subject", german: "fach"},
            {english: "maths", german: "mathematik"},
            {english: "science", german: "naturwissenschaft"},
            {english: "history", german: "geschichte"},
            {english: "art", german: "kunst"},
            {english: "french", german: "franz√∂sisch"},
            {english: "geography", german: "geografie"},
            {english: "also", german: "auch"},
            {english: "passion", german: "leidenschaft"},
            {english: "practice", german: "√ºben"},
            {english: "effort", german: "anstrengung"},
            {english: "proud", german: "stolz"},
            {english: "spend", german: "verbringen"},
            {english: "every day", german: "jeden tag"},
            {english: "at the weekend", german: "am wochenende"},
            {english: "a lot of", german: "viel"},
            {english: "feel", german: "f√ºhlen"},
            {english: "jewellery", german: "schmuck"},
            {english: "exciting", german: "aufregend"},
            {english: "passionate", german: "leidenschaftlich"},
            {english: "inventor", german: "erfinder"},
            {english: "solve a problem", german: "ein problem l√∂sen"},
            {english: "invention", german: "erfindung"}
        ];

        // Game state
        let currentLevel = 0;
        let gameData = [];
        let startTime = 0;
        let timerInterval = null;
        let currentProgress = 0;

        // Firebase config
        const FIREBASE_URL = "https://wortartenspiele-default-rtdb.europe-west1.firebasedatabase.app";
        const GEMINI_API_KEY = "AIzaSyAJ52b330dLaXxZPcLPx8tt7jdl0sdB-2k";

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadHighscores();
        });

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = formatTime(elapsed);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            return Math.floor((Date.now() - startTime) / 1000);
        }

        function updateProgress(current, total) {
            currentProgress = current;
            document.getElementById('progress').textContent = `${current} von ${total}`;
        }

        async function loadHighscores() {
            try {
                for (let i = 1; i <= 4; i++) {
                    const response = await fetch(`${FIREBASE_URL}/highscores/level${i}.json`);
                    const data = await response.json();
                    const element = document.getElementById(`highscore${i}`);
                    if (data && data.time) {
                        element.textContent = `Bester: ${formatTime(data.time)}`;
                    }
                }
            } catch (error) {
                console.error('Fehler beim Laden der Highscores:', error);
            }
        }

        async function saveHighscore(level, time) {
            try {
                // Aktuellen Highscore laden
                const response = await fetch(`${FIREBASE_URL}/highscores/level${level}.json`);
                const currentHighscore = await response.json();
                
                // Nur speichern wenn es ein neuer Rekord ist
                if (!currentHighscore || !currentHighscore.time || time < currentHighscore.time) {
                    await fetch(`${FIREBASE_URL}/highscores/level${level}.json`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            time: time,
                            timestamp: Date.now()
                        })
                    });
                    
                    // UI aktualisieren
                    document.getElementById(`highscore${level}`).textContent = `Bester: ${formatTime(time)}`;
                    return true; // Neuer Rekord
                }
                return false; // Kein neuer Rekord
            } catch (error) {
                console.error('Fehler beim Speichern des Highscores:', error);
                return false;
            }
        }

        function startLevel(level) {
            currentLevel = level;
            document.getElementById('levelSelector').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            document.getElementById('finalScore').classList.add('hidden');
            
            startTimer();
            
            switch(level) {
                case 1: initLevel1(); break;
                case 2: initLevel2(); break;
                case 3: initLevel3(); break;
                case 4: initLevel4(); break;
            }
        }

        function backToMenu() {
            stopTimer();
            document.getElementById('levelSelector').style.display = 'grid';
            document.getElementById('gameArea').style.display = 'none';
        }

        function restartLevel() {
            document.getElementById('finalScore').classList.add('hidden');
            startLevel(currentLevel);
        }

        // LEVEL 1: Drag & Drop
        function initLevel1() {
            const selectedWords = shuffleArray(vocabulary).slice(0, 20);
            gameData = selectedWords;
            
            updateProgress(0, 20);
            
            const shuffledEnglish = shuffleArray([...selectedWords]);
            const shuffledGerman = shuffleArray([...selectedWords]);
            
            const content = `
                <div class="drag-drop-area">
                    <div class="word-list">
                        <h3 style="text-align: center; margin-bottom: 20px;">Englische W√∂rter</h3>
                        ${shuffledEnglish.map((word, index) => 
                            `<div class="word-item" draggable="true" data-english="${word.english}" data-index="${index}">
                                ${word.english}
                            </div>`
                        ).join('')}
                    </div>
                    <div class="word-list">
                        <h3 style="text-align: center; margin-bottom: 20px;">Deutsche √úbersetzungen</h3>
                        ${shuffledGerman.map((word, index) => 
                            `<div class="drop-zone" data-german="${word.german}" data-correct="${word.english}">
                                ${word.german}
                            </div>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('gameContent').innerHTML = content;
            initDragAndDrop();
        }

        function initDragAndDrop() {
            const wordItems = document.querySelectorAll('.word-item');
            const dropZones = document.querySelectorAll('.drop-zone');
            
            wordItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.english);
                    e.target.classList.add('dragging');
                });
                
                item.addEventListener('dragend', (e) => {
                    e.target.classList.remove('dragging');
                });
            });
            
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });
                
                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });
                
                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');
                    
                    const droppedWord = e.dataTransfer.getData('text/plain');
                    const correctWord = zone.dataset.correct;
                    
                    if (droppedWord === correctWord) {
                        zone.classList.add('filled');
                        zone.innerHTML = `${zone.dataset.german}<br><small>${droppedWord}</small>`;
                        
                        // Wort entfernen
                        const draggedItem = document.querySelector(`[data-english="${droppedWord}"]`);
                        if (draggedItem) draggedItem.remove();
                        
                        // Fortschritt pr√ºfen
                        const filled = document.querySelectorAll('.drop-zone.filled').length;
                        updateProgress(filled, 20);
                        
                        if (filled === 20) {
                            finishLevel();
                        }
                    }
                });
            });
        }

        // LEVEL 2: Translation
        function initLevel2() {
            const selectedWords = shuffleArray(vocabulary).slice(0, 15);
            gameData = selectedWords;
            
            updateProgress(0, 15);
            
            const content = `
                <div>
                    <h3 style="text-align: center; margin-bottom: 30px;">√úbersetze die deutschen W√∂rter ins Englische:</h3>
                    ${selectedWords.map((word, index) => 
                        `<div class="translation-item">
                            <strong>${word.german}</strong>
                            <input type="text" class="translation-input" data-correct="${word.english}" 
                                   placeholder="Englische √úbersetzung..." oninput="checkTranslation(this)">
                        </div>`
                    ).join('')}
                </div>
            `;
            
            document.getElementById('gameContent').innerHTML = content;
        }

        function checkTranslation(input) {
            const userAnswer = input.value.trim().toLowerCase();
            const correctAnswer = input.dataset.correct.toLowerCase();
            
            input.classList.remove('correct', 'incorrect');
            
            if (userAnswer && userAnswer === correctAnswer) {
                input.classList.add('correct');
                
                // Fortschritt pr√ºfen
                const correct = document.querySelectorAll('.translation-input.correct').length;
                updateProgress(correct, 15);
                
                if (correct === 15) {
                    finishLevel();
                }
            } else if (userAnswer) {
                input.classList.add('incorrect');
            }
        }

        // LEVEL 3: Dynamic Crossword Generator
        function initLevel3() {
            // 10 zuf√§llige W√∂rter ausw√§hlen
            const selectedWords = shuffleArray(vocabulary).slice(0, 10);
            
            // Kreative Hinweise f√ºr alle W√∂rter generieren
            const wordClues = generateCluesForWords(selectedWords);
            
            // Dynamisches Kreuzwortr√§tsel Layout erstellen
            const crosswordData = generateDynamicCrossword(wordClues);
            
            gameData = crosswordData;
            updateProgress(0, 10);
            
            const content = `
                <div class="crossword-container">
                    <div class="crossword-grid" id="crosswordGrid">
                        ${generateCrosswordHTML(crosswordData)}
                    </div>
                    <div class="crossword-clues">
                        <div class="clues-section">
                            <div class="clues-title">WAAGERECHT</div>
                            ${crosswordData.words.filter(w => w.direction === 'across').map(word => 
                                `<div class="clue-item" data-word-id="${word.number}" onclick="selectWord(${word.number})">
                                    <span class="clue-number">${word.number}.</span> ${word.clue}
                                </div>`
                            ).join('')}
                        </div>
                        <div class="clues-section">
                            <div class="clues-title">SENKRECHT</div>
                            ${crosswordData.words.filter(w => w.direction === 'down').map(word => 
                                `<div class="clue-item" data-word-id="${word.number}" onclick="selectWord(${word.number})">
                                    <span class="clue-number">${word.number}.</span> ${word.clue}
                                </div>`
                            ).join('')}
                        </div>
                        <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 10px;">
                            <strong>Anleitung:</strong><br>
                            ‚Ä¢ Klicke auf einen Hinweis<br>
                            ‚Ä¢ Tippe das Wort ins R√§tsel<br>
                            ‚Ä¢ Benutze Pfeiltasten zum Navigieren
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('gameContent').innerHTML = content;
            initCrosswordEvents();
        }

        function generateCluesForWords(words) {
            const clueTemplates = {
                // Kleidung
                "clothing": "General term for what you wear",
                "jumper": "Warm garment for your upper body",
                "shoes": "Footwear you put on your feet",
                "trousers": "Clothing item covering your legs",
                "pants": "American word for leg covering",
                "blouse": "Elegant shirt often worn by women",
                "cap": "Hat with a visor",
                "belt": "Accessory worn around your waist",
                "watch": "Device worn on wrist to tell time",
                "sunglasses": "Eye protection from bright light",
                "jewellery": "Decorative items like rings and necklaces",
                
                // Schule
                "student": "Person who learns at school or university",
                "backpack": "Bag carried on your back for books",
                "school playground": "Outdoor area where children play at school",
                "at school": "Location where you go to learn",
                "subject": "What you study, like math or history",
                "maths": "Subject involving numbers and calculations",
                "science": "Subject involving experiments and discoveries",
                "history": "Subject about events from the past",
                "art": "Creative subject involving drawing and painting",
                "french": "Language spoken in France",
                "geography": "Subject about countries and maps",
                
                // Eigenschaften & Gef√ºhle
                "interested": "Curious and wanting to know more",
                "good": "The opposite of bad",
                "favourite": "The one you like most",
                "favorite": "American spelling of preferred choice",
                "exciting": "Thrilling and full of energy",
                "passionate": "Having strong enthusiasm for something",
                "proud": "Feeling satisfied with an achievement",
                
                // Aktivit√§ten & Zeit
                "practice": "Do something repeatedly to improve",
                "effort": "Energy and hard work you put into something",
                "spend": "Use time or money for something",
                "every day": "Each day without exception",
                "at the weekend": "During Saturday and Sunday",
                "feel": "Experience an emotion",
                
                // Andere
                "also": "In addition to, as well",
                "passion": "Strong enthusiasm or love for something",
                "a lot of": "Many or much",
                "inventor": "Person who creates new things",
                "solve a problem": "Find an answer to a difficulty",
                "invention": "Something new that someone created"
            };
            
            return words.map(word => ({
                word: word.english.toUpperCase().replace(/\s+/g, ''),
                originalWord: word.english,
                clue: clueTemplates[word.english] || `German: ${word.german}`
            }));
        }

        function generateDynamicCrossword(wordClues) {
            // Sortiere W√∂rter nach L√§nge (l√§ngste zuerst f√ºr bessere Platzierung)
            const sortedWords = [...wordClues].sort((a, b) => b.word.length - a.word.length);
            
            const gridSize = 15;
            const grid = Array(gridSize).fill().map(() => Array(gridSize).fill('#'));
            const placedWords = [];
            
            // Erstes (l√§ngstes) Wort horizontal in der Mitte platzieren
            const firstWord = sortedWords[0];
            const startRow = Math.floor(gridSize / 2);
            const startCol = Math.floor((gridSize - firstWord.word.length) / 2);
            
            // Erstes Wort platzieren
            for (let i = 0; i < firstWord.word.length; i++) {
                grid[startRow][startCol + i] = {
                    letter: firstWord.word[i],
                    number: i === 0 ? 1 : null,
                    wordId: 1,
                    position: i
                };
            }
            
            placedWords.push({
                word: firstWord.word,
                clue: firstWord.clue,
                row: startRow,
                col: startCol,
                direction: 'across',
                number: 1
            });
            
            let wordNumber = 2;
            
            // Versuche restliche W√∂rter zu platzieren - maximal 9 weitere (= 10 total)
            for (let wordIndex = 1; wordIndex < sortedWords.length && placedWords.length < 10; wordIndex++) {
                const currentWord = sortedWords[wordIndex];
                let placed = false;
                
                // Versuche das Wort zu platzieren (mit bereits platzierten W√∂rtern kreuzend)
                for (const placedWord of placedWords) {
                    if (placed) break;
                    
                    // Versuche Kreuzung zu finden
                    for (let i = 0; i < currentWord.word.length; i++) {
                        for (let j = 0; j < placedWord.word.length; j++) {
                            if (currentWord.word[i] === placedWord.word[j]) {
                                // M√∂gliche Kreuzung gefunden
                                let newRow, newCol, direction;
                                
                                if (placedWord.direction === 'across') {
                                    // Platziere vertikal
                                    direction = 'down';
                                    newRow = placedWord.row - i;
                                    newCol = placedWord.col + j;
                                } else {
                                    // Platziere horizontal
                                    direction = 'across';
                                    newRow = placedWord.row + j;
                                    newCol = placedWord.col - i;
                                }
                                
                                // Pr√ºfe ob Platzierung m√∂glich ist
                                if (canPlaceWord(grid, currentWord.word, newRow, newCol, direction, gridSize)) {
                                    // Wort platzieren
                                    for (let k = 0; k < currentWord.word.length; k++) {
                                        const r = direction === 'across' ? newRow : newRow + k;
                                        const c = direction === 'across' ? newCol + k : newCol;
                                        
                                        if (grid[r][c] === '#') {
                                            grid[r][c] = {
                                                letter: currentWord.word[k],
                                                number: k === 0 ? wordNumber : null,
                                                wordId: wordNumber,
                                                position: k
                                            };
                                        } else {
                                            // Kreuzung - aber behalte urspr√ºngliche Struktur
                                            if (k === 0) {
                                                grid[r][c].number = wordNumber;
                                            }
                                        }
                                    }
                                    
                                    placedWords.push({
                                        word: currentWord.word,
                                        clue: currentWord.clue,
                                        row: newRow,
                                        col: newCol,
                                        direction: direction,
                                        number: wordNumber
                                    });
                                    
                                    wordNumber++;
                                    placed = true;
                                    break;
                                }
                            }
                        }
                        if (placed) break;
                    }
                }
                
                // Falls keine Kreuzung m√∂glich, versuche freie Platzierung (nur wenn weniger als 8 W√∂rter)
                if (!placed && placedWords.length < 8) {
                    const placement = findFreeSpace(grid, currentWord.word, gridSize);
                    if (placement) {
                        // Wort an freier Stelle platzieren
                        for (let k = 0; k < currentWord.word.length; k++) {
                            const r = placement.direction === 'across' ? placement.row : placement.row + k;
                            const c = placement.direction === 'across' ? placement.col + k : placement.col;
                            
                            grid[r][c] = {
                                letter: currentWord.word[k],
                                number: k === 0 ? wordNumber : null,
                                wordId: wordNumber,
                                position: k
                            };
                        }
                        
                        placedWords.push({
                            word: currentWord.word,
                            clue: currentWord.clue,
                            row: placement.row,
                            col: placement.col,
                            direction: placement.direction,
                            number: wordNumber
                        });
                        
                        wordNumber++;
                    }
                }
            }
            
            // Sicherstellen, dass wir genau die richtige Anzahl haben
            console.log(`Platzierte W√∂rter: ${placedWords.length}`);
            console.log('Waagerecht:', placedWords.filter(w => w.direction === 'across').length);
            console.log('Senkrecht:', placedWords.filter(w => w.direction === 'down').length);
            
            return {
                words: placedWords,
                grid: grid
            };
        }

        function canPlaceWord(grid, word, row, col, direction, gridSize) {
            if (row < 0 || col < 0) return false;
            
            // Pr√ºfe ob das ganze Wort ins Grid passt
            const endRow = direction === 'across' ? row : row + word.length - 1;
            const endCol = direction === 'across' ? col + word.length - 1 : col;
            
            if (endRow >= gridSize || endCol >= gridSize) return false;
            
            // Pr√ºfe jeden Buchstaben
            for (let i = 0; i < word.length; i++) {
                const r = direction === 'across' ? row : row + i;
                const c = direction === 'across' ? col + i : col;
                
                const cell = grid[r][c];
                
                // Feld muss leer sein oder denselben Buchstaben haben (Kreuzung)
                if (cell !== '#' && cell.letter !== word[i]) {
                    return false;
                }
                
                // Pr√ºfe Nachbarzellen (keine benachbarten W√∂rter)
                if (cell === '#') {
                    const neighbors = [
                        [r-1, c], [r+1, c], [r, c-1], [r, c+1]
                    ];
                    
                    for (const [nr, nc] of neighbors) {
                        if (nr >= 0 && nr < gridSize && nc >= 0 && nc < gridSize) {
                            if (grid[nr][nc] !== '#') {
                                // Nachbar ist besetzt - pr√ºfe ob das eine gewollte Kreuzung ist
                                const isPartOfCurrentWord = (
                                    (direction === 'across' && nr === r && Math.abs(nc - c) === 1) ||
                                    (direction === 'down' && nc === c && Math.abs(nr - r) === 1)
                                );
                                
                                if (!isPartOfCurrentWord) {
                                    // Ungewollte Nachbarschaft
                                    return false;
                                }
                            }
                        }
                    }
                }
            }
            
            return true;
        }

        function findFreeSpace(grid, word, gridSize) {
            const directions = shuffleArray(['across', 'down']);
            
            for (const direction of directions) {
                const positions = [];
                
                // Alle m√∂glichen Positionen sammeln
                for (let row = 2; row < gridSize - 2; row++) {
                    for (let col = 2; col < gridSize - 2; col++) {
                        if (canPlaceWord(grid, word, row, col, direction, gridSize)) {
                            positions.push({ row, col, direction });
                        }
                    }
                }
                
                // Zuf√§llige Position w√§hlen
                if (positions.length > 0) {
                    return positions[Math.floor(Math.random() * positions.length)];
                }
            }
            
            return null;
        }

        function generateCrosswordHTML(crosswordData) {
            let html = '';
            for (let row = 0; row < 15; row++) {
                for (let col = 0; col < 15; col++) {
                    const cell = crosswordData.grid[row][col];
                    if (cell === '#') {
                        html += '<div class="crossword-cell blocked"></div>';
                    } else {
                        const wordIds = cell.wordId.toString().split(',');
                        html += `
                            <div class="crossword-cell" data-row="${row}" data-col="${col}" 
                                 data-word-id="${wordIds[0]}" data-position="${cell.position}">
                                ${cell.number ? `<div class="crossword-number">${cell.number}</div>` : ''}
                                <input type="text" maxlength="1" data-answer="${cell.letter}">
                            </div>
                        `;
                    }
                }
            }
            return html;
        }

        let currentSelectedWord = null;

        function initCrosswordEvents() {
            const inputs = document.querySelectorAll('.crossword-cell input');
            
            inputs.forEach(input => {
                // Klick-Event f√ºr Fokus
                input.addEventListener('click', (e) => {
                    e.target.focus();
                    const wordId = e.target.parentElement.dataset.wordId;
                    selectWord(wordId);
                });
                
                // Input-Event f√ºr Buchstabeneingabe
                input.addEventListener('input', (e) => {
                    let value = e.target.value.toUpperCase();
                    
                    // Nur Buchstaben erlauben
                    value = value.replace(/[^A-Z]/g, '');
                    
                    if (value.length > 1) {
                        value = value.slice(-1); // Nur letzten Buchstaben behalten
                    }
                    
                    e.target.value = value;
                    
                    const correct = e.target.dataset.answer;
                    
                    // Visuelles Feedback
                    e.target.parentElement.classList.remove('filled');
                    if (value === correct) {
                        e.target.parentElement.classList.add('filled');
                        // Automatisch zum n√§chsten Feld
                        moveToNextCell(e.target);
                    }
                    
                    checkCrosswordCompletion();
                });
                
                // Keydown f√ºr Navigation und L√∂schen
                input.addEventListener('keydown', (e) => {
                    switch(e.key) {
                        case 'ArrowRight':
                            e.preventDefault();
                            navigateGrid(e.target, 0, 1);
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            navigateGrid(e.target, 0, -1);
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            navigateGrid(e.target, 1, 0);
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            navigateGrid(e.target, -1, 0);
                            break;
                        case 'Backspace':
                            // Wenn Feld leer ist, gehe zum vorherigen Feld
                            if (!e.target.value) {
                                e.preventDefault();
                                moveToPreviousCell(e.target);
                            } else {
                                // Feld wird automatisch geleert
                                e.target.parentElement.classList.remove('filled');
                            }
                            break;
                        case 'Delete':
                            e.target.value = '';
                            e.target.parentElement.classList.remove('filled');
                            checkCrosswordCompletion();
                            break;
                        case 'Tab':
                            e.preventDefault();
                            if (e.shiftKey) {
                                moveToPreviousCell(e.target);
                            } else {
                                moveToNextCell(e.target);
                            }
                            break;
                        case 'Enter':
                            e.preventDefault();
                            moveToNextCell(e.target);
                            break;
                        case 'Escape':
                            e.target.blur();
                            break;
                    }
                });
                
                // Focus-Event
                input.addEventListener('focus', (e) => {
                    const wordId = e.target.parentElement.dataset.wordId;
                    selectWord(wordId);
                    e.target.select(); // Text ausw√§hlen f√ºr einfaches √úberschreiben
                });
            });
        }

        // Navigation im Grid (Pfeiltasten)
        function navigateGrid(currentInput, rowDelta, colDelta) {
            const currentCell = currentInput.parentElement;
            const currentRow = parseInt(currentCell.dataset.row);
            const currentCol = parseInt(currentCell.dataset.col);
            
            const newRow = currentRow + rowDelta;
            const newCol = currentCol + colDelta;
            
            // Suche n√§chstes verf√ºgbares Feld
            const targetCell = document.querySelector(`[data-row="${newRow}"][data-col="${newCol}"]`);
            
            if (targetCell && !targetCell.classList.contains('blocked')) {
                const targetInput = targetCell.querySelector('input');
                if (targetInput) {
                    targetInput.focus();
                    targetInput.select();
                }
            }
        }

        // Navigation innerhalb eines Wortes (automatisch nach Eingabe)
        function moveToNextCell(currentInput) {
            const currentCell = currentInput.parentElement;
            const wordId = currentCell.dataset.wordId;
            const position = parseInt(currentCell.dataset.position);
            
            // Suche n√§chste Position im selben Wort
            const nextCell = document.querySelector(`[data-word-id="${wordId}"][data-position="${position + 1}"]`);
            
            if (nextCell) {
                const nextInput = nextCell.querySelector('input');
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                    return;
                }
            }
            
            // Wenn kein n√§chstes Feld im Wort, suche n√§chstes leeres Feld
            const allInputs = document.querySelectorAll('.crossword-cell input');
            for (let input of allInputs) {
                if (!input.value) {
                    input.focus();
                    input.select();
                    break;
                }
            }
        }

        function moveToPreviousCell(currentInput) {
            const currentCell = currentInput.parentElement;
            const wordId = currentCell.dataset.wordId;
            const position = parseInt(currentCell.dataset.position);
            
            // Suche vorherige Position im selben Wort
            const prevCell = document.querySelector(`[data-word-id="${wordId}"][data-position="${position - 1}"]`);
            
            if (prevCell) {
                const prevInput = prevCell.querySelector('input');
                if (prevInput) {
                    prevInput.focus();
                    prevInput.select();
                    return;
                }
            }
            
            // Wenn kein vorheriges Feld im Wort, suche letztes ausgef√ºlltes Feld
            const allInputs = Array.from(document.querySelectorAll('.crossword-cell input')).reverse();
            for (let input of allInputs) {
                if (input.value && input !== currentInput) {
                    input.focus();
                    input.select();
                    break;
                }
            }
        }

        function selectWord(wordId) {
            if (!wordId) return;
            
            // Alle Hervorhebungen entfernen
            document.querySelectorAll('.crossword-cell').forEach(cell => {
                cell.classList.remove('current-word', 'active');
            });
            document.querySelectorAll('.clue-item').forEach(clue => {
                clue.classList.remove('active');
            });
            
            // Aktuelles Wort und Hinweis hervorheben
            document.querySelectorAll(`[data-word-id="${wordId}"]`).forEach(element => {
                if (element.classList.contains('crossword-cell')) {
                    element.classList.add('current-word');
                } else if (element.classList.contains('clue-item')) {
                    element.classList.add('active');
                }
            });
            
            currentSelectedWord = wordId;
        }

        function checkCrosswordCompletion() {
            const allInputs = document.querySelectorAll('.crossword-cell:not(.blocked) input');
            const correctInputs = Array.from(allInputs).filter(input => {
                return input.value.toUpperCase() === input.dataset.answer;
            });
            
            updateProgress(correctInputs.length, allInputs.length);
            
            // Level ist abgeschlossen wenn alle Felder korrekt sind
            if (correctInputs.length === allInputs.length && allInputs.length > 0) {
                // Alle W√∂rter als abgeschlossen markieren
                document.querySelectorAll('.clue-item').forEach(clue => {
                    clue.classList.add('completed');
                });
                
                setTimeout(() => {
                    finishLevel();
                }, 500);
            }
        }

        // LEVEL 4: AI Description
        function initLevel4() {
            const selectedWords = shuffleArray(vocabulary).slice(0, 5);
            gameData = selectedWords;
            currentProgress = 0;
            
            updateProgress(0, 5);
            showNextDescription();
        }

        function showNextDescription() {
            if (currentProgress >= 5) {
                finishLevel();
                return;
            }
            
            const word = gameData[currentProgress];
            
            const content = `
                <div class="description-item">
                    <div class="word-to-describe">${word.english}</div>
                    <p style="margin-bottom: 20px;">Beschreibe dieses Wort auf Englisch:</p>
                    <textarea class="description-input" id="descriptionInput" 
                              placeholder="Write your description in English..."></textarea>
                    <div>
                        <button class="btn btn-primary" onclick="checkDescription()">
                            Beschreibung pr√ºfen
                        </button>
                    </div>
                    <div id="aiFeedback"></div>
                </div>
            `;
            
            document.getElementById('gameContent').innerHTML = content;
            document.getElementById('descriptionInput').focus();
        }

        async function checkDescription() {
            const description = document.getElementById('descriptionInput').value.trim();
            
            if (!description) {
                alert('Bitte gib eine Beschreibung ein!');
                return;
            }
            
            const feedbackElement = document.getElementById('aiFeedback');
            feedbackElement.innerHTML = '<div class="ai-feedback"><div class="loading"></div> KI bewertet deine Beschreibung...</div>';
            
            try {
                const word = gameData[currentProgress];
                const aiResult = await evaluateWithAI(word.english, description);
                
                feedbackElement.innerHTML = `
                    <div class="ai-feedback">
                        <strong>KI-Bewertung:</strong> ${aiResult.feedback}
                        <div style="margin-top: 10px;">
                            <button class="btn btn-success" onclick="nextDescription()">
                                Weiter zur n√§chsten Aufgabe
                            </button>
                        </div>
                    </div>
                `;
            } catch (error) {
                feedbackElement.innerHTML = `
                    <div class="ai-feedback">
                        <strong>Fehler:</strong> KI-Bewertung nicht verf√ºgbar. 
                        <button class="btn btn-success" onclick="nextDescription()">
                            Trotzdem weiter
                        </button>
                    </div>
                `;
            }
        }

        function nextDescription() {
            currentProgress++;
            updateProgress(currentProgress, 5);
            showNextDescription();
        }

        async function evaluateWithAI(word, userDefinition) {
            const prompt = `Bewerte diese englische Definition eines deutschen Sch√ºlers kurz und motivierend:
            
Wort: "${word}"
Definition des Sch√ºlers: "${userDefinition}"

Gib eine kurze, positive Bewertung auf Deutsch (max. 2 S√§tze).`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            if (!response.ok) {
                throw new Error(`API Error: ${response.status}`);
            }

            const data = await response.json();
            const feedback = data.candidates[0].content.parts[0].text;
            
            return { feedback: feedback.trim() };
        }

        async function finishLevel() {
            const finalTime = stopTimer();
            const isNewRecord = await saveHighscore(currentLevel, finalTime);
            
            document.getElementById('finalTitle').textContent = `Level ${currentLevel} abgeschlossen!`;
            document.getElementById('finalTime').textContent = formatTime(finalTime);
            document.getElementById('finalMessage').textContent = isNewRecord ? 
                'üèÜ Gratulation! Du hast einen neuen Rekord aufgestellt!' : 
                'üëç Gut gemacht! Versuche es nochmal f√ºr einen neuen Rekord!';
            
            document.getElementById('gameContent').style.display = 'none';
            document.getElementById('finalScore').classList.remove('hidden');
        }
    </script>
</body>
</html>
